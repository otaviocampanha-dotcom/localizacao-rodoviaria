<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Localiza√ß√£o Rodovi√°ria</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    button { margin: 5px; }
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; }
    #alerta { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>üìç Localiza√ß√£o Rodovi√°ria</h2>

  <input type="file" id="csvFile" accept=".csv" />
  <button onclick="iniciarLocalizacao()">Obter Localiza√ß√£o Atual</button>
  <button onclick="savePoint('A')">Salvar Localiza√ß√£o A</button>
  <button onclick="savePoint('B')">Salvar Localiza√ß√£o B</button>
  <button onclick="calculateAB()">Calcular Dist√¢ncia A‚ÜîB</button>
  <button onclick="exportHistory()">Exportar Hist√≥rico</button>

  <p>Latitude: <span id="lat">--</span></p>
  <p>Longitude: <span id="lon">--</span></p>
  <p>Precis√£o: <span id="precisao">--</span></p>
  <p id="alerta"></p>
  <p id="output"></p>

  <table id="historyTable">
    <tr><th>Data</th><th>Lat</th><th>Lon</th><th>Rodovia</th><th>Km</th><th>Sentido</th><th>Dist√¢ncia</th><th>A‚ÜîB</th></tr>
  </table>

  <script>
    let points = [];
    let history = [];
    let pointA = null, pointB = null;

    function parseCSV(text) {
      const lines = text.trim().split("\n").slice(1);
      points = lines.map(line => {
        const [rodovia, km, sentido, lat, lon] = line.split(",");
        return { rodovia, km, sentido, lat: parseFloat(lat), lon: parseFloat(lon) };
      });
      alert("Planilha carregada com " + points.length + " pontos.");
    }

    document.getElementById("csvFile").addEventListener("change", function () {
      const reader = new FileReader();
      reader.onload = () => parseCSV(reader.result);
      reader.readAsText(this.files[0]);
    });

    function iniciarLocalizacao() {
      if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition(pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const accuracy = pos.coords.accuracy;

          document.getElementById("lat").textContent = lat.toFixed(6);
          document.getElementById("lon").textContent = lon.toFixed(6);
          document.getElementById("precisao").textContent = accuracy + " metros";

          if (accuracy > 300) {
            document.getElementById("alerta").textContent = "‚ö†Ô∏è GPS muito impreciso. Aguarde melhor sinal.";
            return;
          } else if (accuracy > 100) {
            document.getElementById("alerta").textContent = "‚ö†Ô∏è GPS moderado. Dados podem ter pequena varia√ß√£o.";
          } else {
            document.getElementById("alerta").textContent = "";
          }

          const nearest = findNearest(lat, lon);
          const dist = haversine(lat, lon, nearest.lat, nearest.lon);
          const now = new Date().toLocaleString();

          history.push({ date: now, lat, lon, ...nearest, dist: dist.toFixed(1), ab: "" });
          updateTable();

          let mensagem = `Mais pr√≥ximo: ${nearest.rodovia}, km ${nearest.km} ${nearest.sentido} (${dist.toFixed(1)} m)`;
          if (dist > 500) {
            mensagem += "\nPossivelmente fora da faixa de dom√≠nio da concession√°ria";
          }

          document.getElementById("output").innerText = mensagem;
        },
        error => {
          alert("Erro ao obter localiza√ß√£o: " + error.message);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        });
      } else {
        alert("Geolocaliza√ß√£o n√£o √© suportada neste navegador.");
      }
    }

    function findNearest(lat, lon) {
      let minDist = Infinity, nearest = null;
      for (const p of points) {
        const d = haversine(lat, lon, p.lat, p.lon);
        if (d < minDist) {
          minDist = d;
          nearest = p;
        }
      }
      return nearest;
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function savePoint(label) {
      const lat = parseFloat(document.getElementById("lat").textContent);
      const lon = parseFloat(document.getElementById("lon").textContent);
      if (isNaN(lat) || isNaN(lon)) {
        alert("Localiza√ß√£o n√£o dispon√≠vel.");
        return;
      }
      const coord = { lat, lon };
      if (label === 'A') pointA = coord;
      else pointB = coord;
      alert(`Localiza√ß√£o ${label} salva.`);
    }

    function calculateAB() {
      if (!pointA || !pointB) return alert("Salve os dois pontos primeiro.");
      const dist = haversine(pointA.lat, pointA.lon, pointB.lat, pointB.lon);
      const last = history[history.length - 1];
      if (last) last.ab = dist.toFixed(1);
      updateTable();
      alert(`Dist√¢ncia entre A e B: ${dist.toFixed(1)} metros`);
    }

    function updateTable() {
      const rows = history.map(h =>
        `<tr><td>${h.date}</td><td>${h.lat}</td><td>${h.lon}</td><td>${h.rodovia}</td><td>${h.km}</td><td>${h.sentido}</td><td>${h.dist}</td><td>${h.ab}</td></tr>`
      ).join("");
      document.getElementById("historyTable").innerHTML =
        `<tr><th>Data</th><th>Lat</th><th>Lon</th><th>Rodovia</th><th>Km</th><th>Sentido</th><th>Dist√¢ncia</th><th>A‚ÜîB</th></tr>` + rows;
    }

    function exportHistory() {
      const csv = "Data,Lat,Lon,Rodovia,Km,Sentido,Dist√¢ncia,A‚ÜîB\n" +
        history.map(h => `${h.date},${h.lat},${h.lon},${h.rodovia},${h.km},${h.sentido},${h.dist},${h.ab}`).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "historico_localizacao.csv";
      a.click();
    }
  </script>
</body>
</html>
