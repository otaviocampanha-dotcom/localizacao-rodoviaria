<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Localiza√ß√£o Rodovi√°ria</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    button { margin: 5px; }
    #alerta { color: red; font-weight: bold; }
    #output { white-space: pre-line; font-weight: bold; }
  </style>
</head>
<body>
  <h2>üìç Localiza√ß√£o Rodovi√°ria</h2>

  <input type="file" id="csvFile" accept=".csv" />
  <button onclick="iniciarLocalizacao()">Obter Localiza√ß√£o Atual</button>

  <p>Latitude: <span id="lat">--</span></p>
  <p>Longitude: <span id="lon">--</span></p>
  <p>Precis√£o: <span id="precisao">--</span></p>
  <p id="alerta"></p>
  <p id="output"></p>

  <script>
    let points = [];

    function parseCSV(text) {
      const lines = text.trim().split("\n").slice(1);
      points = lines.map(line => {
        const [rodovia, km, sentido, lat, lon] = line.split(",");
        return { rodovia, km, sentido, lat: parseFloat(lat), lon: parseFloat(lon) };
      });
      alert("Planilha carregada com " + points.length + " pontos.");
    }

    document.getElementById("csvFile").addEventListener("change", function () {
      const reader = new FileReader();
      reader.onload = () => parseCSV(reader.result);
      reader.readAsText(this.files[0]);
    });

    function iniciarLocalizacao() {
      if (!points.length) {
        alert("Carregue a planilha primeiro.");
        return;
      }

      document.getElementById("output").textContent = "Calculando menor dist√¢ncia, aguarde‚Ä¶";

      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const accuracy = pos.coords.accuracy;

        document.getElementById("lat").textContent = lat.toFixed(6);
        document.getElementById("lon").textContent = lon.toFixed(6);
        document.getElementById("precisao").textContent = accuracy + " metros";

        if (accuracy > 300) {
          document.getElementById("alerta").textContent = "‚ö†Ô∏è GPS muito impreciso. Aguarde melhor sinal.";
          return;
        } else if (accuracy > 100) {
          document.getElementById("alerta").textContent = "‚ö†Ô∏è GPS moderado. Dados podem ter pequena varia√ß√£o.";
        } else {
          document.getElementById("alerta").textContent = "";
        }

        setTimeout(() => {
          const nearest = findNearest(lat, lon);
          const dist = haversine(lat, lon, nearest.lat, nearest.lon);
          let mensagem = `Mais pr√≥ximo: ${nearest.rodovia}, km ${nearest.km} ${nearest.sentido} (${dist.toFixed(1)} m)`;
          if (dist > 500) {
            mensagem += "\nPossivelmente fora da faixa de dom√≠nio da concession√°ria";
          }
          document.getElementById("output").textContent = mensagem;
        }, 500); // pequena pausa para simular processamento
      },
      error => {
        alert("Erro ao obter localiza√ß√£o: " + error.message);
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    }

    function findNearest(lat, lon) {
      let minDist = Infinity, nearest = null;
      for (const p of points) {
        const d = haversine(lat, lon, p.lat, p.lon);
        if (d < minDist) {
          minDist = d;
          nearest = p;
        }
      }
      return nearest;
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }
  </script>
</body>
</html>
