<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Localiza√ß√£o Rodovi√°ria</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    button { margin: 5px; }
    #alerta { color: red; font-weight: bold; }
    #output { white-space: pre-line; font-weight: bold; }
    #mapaBtn { display: none; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>üìç Localiza√ß√£o Rodovi√°ria</h2>

  <input type="file" id="csvFile" accept=".csv" />
  <button onclick="iniciarLocalizacao()">Obter Localiza√ß√£o Atual</button>

  <p>Latitude: <span id="lat">--</span></p>
  <p>Longitude: <span id="lon">--</span></p>
  <p>Precis√£o: <span id="precisao">--</span></p>
  <p id="alerta"></p>
  <p id="output"></p>
  <button id="mapaBtn" onclick="abrirNoMaps()">Abrir no Google Maps</button>

  <script>
    let points = [];
    let ultimaLat = null;
    let ultimaLon = null;

    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      points = [];

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        const sep = line.includes(";") ? ";" : ",";
        const cols = line.split(sep);

        if (cols.length < 5) continue;

        const lat = parseFloat(cols[3].replace(",", ".").replace(/"/g, ""));
        const lon = parseFloat(cols[4].replace(",", ".").replace(/"/g, ""));

        if (isNaN(lat) || isNaN(lon)) continue;

        points.push({
          rodovia: cols[0].replace(/"/g, "").trim(),
          km: cols[1].replace(/"/g, "").trim(),
          sentido: cols[2].replace(/"/g, "").trim(),
          lat,
          lon
        });
      }

      alert("Planilha carregada com " + points.length + " pontos.");
    }

    document.getElementById("csvFile").addEventListener("change", function () {
      const reader = new FileReader();
      reader.onload = () => parseCSV(reader.result);
      reader.readAsText(this.files[0]);
    });

    function iniciarLocalizacao() {
      if (!points.length) {
        alert("Carregue a planilha primeiro.");
        return;
      }

      document.getElementById("output").textContent = "Calculando menor dist√¢ncia, aguarde‚Ä¶";
      document.getElementById("mapaBtn").style.display = "none";

      navigator.geolocation.getCurrentPosition(pos => {
        const lat1 = pos.coords.latitude;
        const lon1 = pos.coords.longitude;
        const accuracy = pos.coords.accuracy;

        ultimaLat = lat1;
        ultimaLon = lon1;

        document.getElementById("lat").textContent = lat1.toFixed(6);
        document.getElementById("lon").textContent = lon1.toFixed(6);
        document.getElementById("precisao").textContent = accuracy + " metros";

        if (accuracy > 300) {
          document.getElementById("alerta").textContent = "‚ö†Ô∏è GPS muito impreciso. Aguarde melhor sinal.";
          return;
        } else if (accuracy > 100) {
          document.getElementById("alerta").textContent = "‚ö†Ô∏è GPS moderado. Dados podem ter pequena varia√ß√£o.";
        } else {
          document.getElementById("alerta").textContent = "";
        }

        setTimeout(() => {
          let minDist = Infinity;
          let nearest = null;

          points.forEach(p => {
            const dist = calcularDistanciaMacro(lat1, lon1, p.lat, p.lon);
            if (dist < minDist) {
              minDist = dist;
              nearest = p;
              nearest.distancia = dist;
            }
          });

          const dist = nearest.distancia;
          let mensagem = `Mais pr√≥ximo: ${nearest.rodovia}, km ${nearest.km} ${nearest.sentido} (${dist.toFixed(1)} m)`;
          if (dist > 500) {
            mensagem += "\nPossivelmente fora da faixa de dom√≠nio da concession√°ria";
          }

          document.getElementById("output").textContent = mensagem;
          document.getElementById("mapaBtn").style.display = "inline-block";
        }, 500);
      },
      error => {
        alert("Erro ao obter localiza√ß√£o: " + error.message);
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    }

    function abrirNoMaps() {
      if (ultimaLat && ultimaLon) {
        const url = `https://www.google.com/maps?q=${ultimaLat},${ultimaLon}`;
        window.open(url, "_blank");
      }
    }

    function calcularDistanciaMacro(lat1, lon1, lat2, lon2) {
      const toRad = deg => deg * Math.PI / 180;
      const R = 6371; // km

      const lat1r = toRad(90 - lat1);
      const lat2r = toRad(90 - lat2);
      const lonDiff = toRad(lon1 - lon2);

      const cosDist = Math.cos(lat1r) * Math.cos(lat2r) + Math.sin(lat1r) * Math.sin(lat2r) * Math.cos(lonDiff);
      const dist = R * Math.acos(cosDist) * 1000; // metros

      return dist;
    }
  </script>
</body>
</html>
